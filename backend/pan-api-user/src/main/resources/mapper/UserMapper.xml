<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">

<mapper namespace="io.github.panjung99.panapi.user.dao.UserMapper">

    <resultMap id="userResultMap" type="io.github.panjung99.panapi.user.entity.User">
        <id property="id" column="id"/>
        <result property="username" column="username"/>
        <result property="loginType" column="login_type"/>
        <result property="password" column="password"/>
        <result property="wechatOpenid" column="wechat_openid"/>
        <result property="phone" column="phone"/>
        <result property="email" column="email"/>
        <result property="deleted" column="is_deleted"/>
        <result property="createTime" column="create_time"/>
        <result property="updateTime" column="update_time"/>
    </resultMap>

    <insert id="insert" useGeneratedKeys="true" keyProperty="id">
        INSERT INTO us_user (
            username, login_type, password,
            wechat_openid, phone, email, is_deleted
        ) VALUES (
             #{username}, #{loginType}, #{password},
             #{wechatOpenid}, #{phone}, #{email}, #{deleted}
        )
    </insert>

    <update id="softDelete">
        UPDATE us_user
        SET is_deleted = 1, update_time = CURRENT_TIMESTAMP
        WHERE id = #{id}
    </update>

    <select id="findById" resultMap="userResultMap">
        SELECT * FROM us_user WHERE id = #{id} AND is_deleted = 0
    </select>

    <select id="findByWechatOpenid" resultMap="userResultMap">
        SELECT * FROM us_user
        WHERE wechat_openid = #{openid} AND is_deleted = 0
    </select>

    <select id="findByPhone" resultMap="userResultMap">
        SELECT * FROM us_user
        WHERE phone = #{phone} AND is_deleted = 0
    </select>

    <select id="findByEmail" resultMap="userResultMap">
        SELECT * FROM us_user
        WHERE email = #{email} AND is_deleted = 0
    </select>

    <select id="findByLoginType" resultMap="userResultMap">
        SELECT * FROM us_user
        WHERE login_type = #{loginType} AND is_deleted = 0
    </select>

    <update id="updateBalance">
        UPDATE us_user
        SET balance = balance + #{amount},
            update_time = CURRENT_TIMESTAMP
        WHERE id = #{id}
    </update>

    <update id="updatePassword">
        UPDATE us_user
        SET password = #{password},
            update_time = CURRENT_TIMESTAMP
        WHERE id = #{id}
    </update>

    <resultMap id="adminUserRespResultMap" type="io.github.panjung99.panapi.common.dto.admin.AdminUserResp">
        <id property="id" column="id"/>
        <result property="loginType" column="login_type"/>
        <result property="username" column="username"/>
        <result property="phone" column="phone"/>
        <result property="email" column="email"/>
        <result property="balance" column="current_balance"/>
        <result property="createTime" column="create_time"/>
    </resultMap>

    <select id="findUserPage" resultMap="adminUserRespResultMap">
        SELECT
            u.id,
            u.login_type,
            u.username,
            u.phone,
            u.email,
            COALESCE(b.current_balance, 0) AS current_balance,
            u.create_time
        FROM us_user u
        LEFT JOIN us_balance b ON u.id = b.user_id
        WHERE u.is_deleted = 0
        ORDER BY u.create_time DESC
    </select>

</mapper>